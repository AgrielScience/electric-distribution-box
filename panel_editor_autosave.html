
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Редактор с автосохранением</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; margin: 0; }
    .container { position: relative; max-width: 800px; margin: 20px auto; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
    img { width: 100%; display: block; }
    .zone { position: absolute; border-radius: 4px; border: 2px dashed transparent; cursor: move; }
    .zone.selected { border-color: #007bff; background-color: rgba(0, 123, 255, 0.2); }
    .zone[data-type="свет"] { background-color: rgba(0, 128, 255, 0.1); }
    .zone[data-type="розетки"] { background-color: rgba(255, 0, 0, 0.1); }
    .zone[data-type="теплый пол"] { background-color: rgba(255, 165, 0, 0.1); }
    .controls { max-width: 800px; margin: 10px auto; background: #fff; padding: 10px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
    input, select, button { margin: 5px; padding: 5px; font-size: 14px; }
    textarea { width: 100%; height: 120px; font-family: monospace; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="controls">
    <h3>Управление зонами</h3>
    <label>Кратко: <input type="text" id="info" /></label>
    <label>Подробно: <input type="text" id="detail" /></label>
    <label>Тип:
      <select id="type">
        <option value="свет">Свет</option>
        <option value="розетки">Розетки</option>
        <option value="теплый пол">Тёплый пол</option>
      </select>
    </label>
    <label>Ширина: <input type="number" id="width" value="50" /></label>
    <label>Высота: <input type="number" id="height" value="65" /></label>
    <button onclick="createZone()">Добавить</button>
    <button onclick="updateZone()">Обновить</button>
    <button onclick="deleteZone()">Удалить</button>
    <button onclick="downloadZones()">Скачать JSON</button>
  </div>

  <div class="container" id="panel">
    <img src="panel_v2.png" alt="Электрощит" />
  </div>

  <script>
    const panel = document.getElementById('panel');
    const infoInput = document.getElementById('info');
    const detailInput = document.getElementById('detail');
    const typeInput = document.getElementById('type');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');

    let zones = [];
    let selectedZone = null;
    let offsetX = 0, offsetY = 0;

    function createZone() {
      const div = document.createElement('div');
      div.className = 'zone';
      div.style.left = '100px';
      div.style.top = '100px';
      div.style.width = widthInput.value + 'px';
      div.style.height = heightInput.value + 'px';
      div.dataset.info = infoInput.value;
      div.dataset.detail = detailInput.value;
      div.dataset.type = typeInput.value;
      makeDraggable(div);
      panel.appendChild(div);
      zones.push(div);
      selectZone(div);
      saveZones();
    }

    function selectZone(el) {
      zones.forEach(z => z.classList.remove('selected'));
      selectedZone = el;
      el.classList.add('selected');
      infoInput.value = el.dataset.info;
      detailInput.value = el.dataset.detail;
      typeInput.value = el.dataset.type;
      widthInput.value = parseInt(el.style.width);
      heightInput.value = parseInt(el.style.height);
    }

    function updateZone() {
      if (!selectedZone) return;
      selectedZone.dataset.info = infoInput.value;
      selectedZone.dataset.detail = detailInput.value;
      selectedZone.dataset.type = typeInput.value;
      selectedZone.style.width = widthInput.value + 'px';
      selectedZone.style.height = heightInput.value + 'px';
      saveZones();
    }

    function deleteZone() {
      if (!selectedZone) return;
      panel.removeChild(selectedZone);
      zones = zones.filter(z => z !== selectedZone);
      selectedZone = null;
      saveZones();
    }

    function makeDraggable(el) {
      el.addEventListener('mousedown', e => {
        selectZone(el);
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        function move(ev) {
          el.style.left = (ev.pageX - panel.offsetLeft - offsetX) + 'px';
          el.style.top = (ev.pageY - panel.offsetTop - offsetY) + 'px';
        }
        function stop() {
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', stop);
          saveZones();
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', stop);
      });
      el.addEventListener('click', () => selectZone(el));
    }

    function saveZones() {
      const data = zones.map(z => ({
        x: parseInt(z.style.left),
        y: parseInt(z.style.top),
        width: parseInt(z.style.width),
        height: parseInt(z.style.height),
        info: z.dataset.info,
        detail: z.dataset.detail,
        type: z.dataset.type
      }));
      localStorage.setItem("zones", JSON.stringify(data));
    }

    function loadZones() {
      const raw = localStorage.getItem("zones");
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        data.forEach(z => {
          const div = document.createElement('div');
          div.className = 'zone';
          div.style.left = z.x + 'px';
          div.style.top = z.y + 'px';
          div.style.width = z.width + 'px';
          div.style.height = z.height + 'px';
          div.dataset.info = z.info;
          div.dataset.detail = z.detail;
          div.dataset.type = z.type;
          makeDraggable(div);
          panel.appendChild(div);
          zones.push(div);
        });
      } catch (e) {
        console.error("Ошибка загрузки зон:", e);
      }
    }

    function downloadZones() {
      const blob = new Blob([localStorage.getItem("zones")], { type: 'application/json' });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "zones.json";
      a.click();
    }

    window.onload = loadZones;
  </script>
</body>
</html>
